"use strict";void 0===window.$&&(window.$=MyAMS.$);const chat={unloadHandler:null,wsClient:null,accessToken:null,refreshToken:null,checkInterval:null,initChat:()=>{chat.openConnection()},openConnection:()=>{const e=$("#user-notifications"),t=e.data("ams-notifications-endpoint");t&&MyAMS.require("ajax","notifications").then(()=>{MyAMS.ajax.get(`${e.data("ams-jwt-verify-route")}`).then(e=>{"success"===e.status&&(chat.accessToken=e.accessToken,chat.refreshToken=e.refreshToken,chat.wsClient=new WebSocket(t,["accessToken",chat.accessToken]),chat.wsClient.onopen=chat.onOpened,chat.wsClient.onmessage=chat.onMessage,chat.wsClient.onclose=chat.onClosed,null!==chat.checkInterval&&clearInterval(chat.checkInterval),chat.checkInterval=setInterval(chat.checkConnection,3e4))})})},checkConnection:()=>{null!==chat.wsClient&&chat.wsClient.readyState!==WebSocket.CLOSED||chat.openConnection()},onOpened:e=>{console.debug("WS opened",e)},onMessage:e=>{let t=e.data;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){return void console.debug(t)}chat.showDesktopNotification(t)},showDesktopNotification:e=>{const t=()=>{const t={title:e.title,body:e.message,icon:e.source.avatar},n=new Notification(t.title,t);e.url&&(n.onclick=()=>{window.open(e.url)})};"Notification"in window?"denied"!==Notification.permission&&("default"===Notification.permission?(()=>{try{Notification.requestPermission().then()}catch(e){return!1}return!0})()?Notification.requestPermission().then(e=>{"granted"===e&&t()}):Notification.requestPermission(e=>{"granted"===e&&t()}):t()):console.debug("Notifications are not supported by this browser!")},onClosed:e=>{chat.wsClient=null,console.debug("WS closed !!!",e)}};window.MyAMS&&(MyAMS.config.modules.push("myams_chat"),MyAMS.chat=chat,console.debug("MyAMS: chat module loaded..."));
