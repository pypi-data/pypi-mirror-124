define(["jquery","base/js/keyboard","require","base/js/namespace","base/js/dialog","base/js/i18n","notebook/js/codecell","codemirror/lib/codemirror","module"],(function(e,t,o,n,r,s,i,c,a){"use strict";const l="["+a.id+"]",u="https://uploads-ssl.webflow.com/61294dc1bd225d7c490b4389/6131d7249979f73249363dd0_icon_black_64.png";let p={suggestion_opacity:.5,suggestion_accept_delay:6e5,modify_query_delay:2e3,cursor_blink_rate:530,upgrade_message_timeout:12e4,should_prepend_imports:!0,auto_submit:!1,demo_mode:!0,temperature:.2,n_suggestions:3,prompt_presets:""},d={is_open:!1,current_choice_idx:void 0,choices:[],considering_choices:!1,suggestionAcceptTimeout:void 0,version_is_up_to_date:void 0,queryTimeout:void 0,pre_cursor:void 0,post_cursor:void 0,pre_cursor_plus_code:void 0,pre_cursor_plus_imports:void 0,pre_cursor_plus_imports_code:void 0,suggestion:void 0,auth_token:void 0,current_completion_query:void 0},g=i.CodeCell,m=t.keycodes,_=[m.enter,m.esc,m.shift,m.ctrl,m.alt,m.meta,m.capslock,m.pageup,m.pagedown,m.end,m.home,m.insert,m.delete,m.numlock,m.f1,m.f2,m.f3,m.f4,m.f5,m.f6,m.f7,m.f8,m.f9,m.f10,m.f11,m.f12,m.f13,m.f14,m.f15];const h=e=>{const t=document.cookie.match("\\b"+e+"=([^;]*)\\b");return t?t[1]:void 0},f=()=>n.notebook.get_selected_cell(),y=(navigator.platform.toUpperCase().indexOf("MAC"),e=>{const t=e.split("\n");if(0===t.length)return[0,0];return[t.length-1,t.slice(-1)[0].length]}),b=({text:e,_cell:t})=>{const[o,n]=y(e);t||(t=f()),t.code_mirror.setCursor(o,n)},k=(e,t,o)=>{e.code_mirror.options[t]=o},v=(e,t,o,n)=>{e.code_mirror.markText(t,o,{css:`opacity:${n};`})},x=e=>{const t=y(e);return{line:t[0],ch:t[1]}},T=()=>{const e=w()??"",t=d.choices[d.current_choice_idx].suggestion,o=d.pre_cursor+t,n=e+d.pre_cursor,r=n+t;d.suggestion=t,d.pre_cursor_plus_code=o,d.pre_cursor_plus_imports=n,d.pre_cursor_plus_imports_code=r},C=()=>{void 0!==d.suggestionAcceptTimeout&&clearTimeout(d.suggestionAcceptTimeout)},w=()=>{const e=d.choices[d.current_choice_idx].imports;if(e)return e+"\n\n"},j=()=>{if(!d.considering_choices)return;const e=f();(e=>{const t=w(e);p.should_prepend_imports&&t&&e.set_text(d.pre_cursor_plus_imports_code)})(e);const t=x(d.pre_cursor_plus_imports_code);v(e,{line:0,ch:0},t,1),b({text:d.pre_cursor_plus_imports_code,_cell:e}),le(),S()},S=()=>{d.considering_choices=!1,d.choices=[],d.pre_cursor=void 0,d.post_cursor=void 0},$=()=>{let t=e(".cogram-demo-hint");if(t.length){let e=f();t.remove(),k(e,"cursorBlinkRate",p.cursor_blink_rate);const o=x(d.pre_cursor_plus_imports_code);e.code_mirror.setSelection(o)}},N=e=>new Promise((t=>setTimeout(t,e))),q=async(e,t)=>{let o,n=t.split("\n"),r=e.line,s=[];return n.forEach((t=>{let n=r===e.line?e.ch:0;o={line:r,ch:n+t.length},s.push({anchor:{line:r,ch:n},head:o}),++r})),await N(1),ae(`<img id="cogram-button-logo" src="${u}" style="max-height:16px;"alt="Cogram"> Cogram`,"cogram-demo-hint","+=9"),k(f(),"cursorBlinkRate",-1),f().code_mirror.setSelections(s),o},O=async()=>{const t=x(d.pre_cursor_plus_imports);if(q(t,d.suggestion),p.demo_mode)j();else{j(),await N(1);let t=e("#cogram-hint");t.css("opacity","0"),t.bind("transitionend",(()=>{$()})),t=e(".CodeMirror-selected"),t.css("opacity","0")}},R=()=>{T();let e=f();d.current_completion_query=void 0,d.considering_choices=!0,ue(),C();const t=d.pre_cursor_plus_code+d.post_cursor;e.set_text(t);const o=x(d.pre_cursor),n=x(d.pre_cursor_plus_code);v(e,o,n,p.suggestion_opacity),b({text:d.pre_cursor,_cell:e})},A=t=>{t?e("#cogram-spinner").addClass("fa-spin").css("color","orange"):e("#cogram-spinner").removeClass("fa-spin").css("color","green")},J=()=>{const t=n.notebook.get_selected_index();let o=n.notebook.get_cells().map((e=>e.get_text())).slice(0,t+1);o.pop();let r=f();d.pre_cursor=r.get_pre_cursor(),d.post_cursor=(e=>e.get_post_cursor())(r);let s={queries:[d.pre_cursor],cell_contents:o,auth_token:d.auth_token,n_suggestions:p.n_suggestions,temperature:p.temperature,prompt_presets:p.prompt_presets,language:(i=r,i.get_text().startsWith("%%sql")?"sql":"python")};var i;const c=h("_xsrf");d.current_completion_query=e.post({url:"/cogram",data:JSON.stringify(s),headers:{"X-XSRFToken":c},dataType:"json",contentType:"application/json",beforeSend:function(e){A(!0)},success:function(e){((e,t)=>{let o=t.message;o=o.filter((e=>""!==e.suggestion.trim())),o.length>0&&(d.choices=o,d.current_choice_idx=0,T(),R())})(0,e)},error:Z,complete:function(){A(!1)}})},D=(t=!1)=>{const o="boolean"==typeof t&&t;console.log(l,"Checking if valid token exists with `logLaunch`=",o);let n=null;return e.get({url:"/token",dataType:"JSON",data:{log_launch:o},async:!1,success:function(e){var t;t=e,d.auth_token=t.auth_token,n="ok"},error:function(e,t,o){n=((e,t,o)=>{d.auth_token=void 0,console.log(l,"`checkValidTokenExists` ajax error:",e,t,o);const n=e.status;if(500===n)return"unavailable";if(403==n){let t=JSON.parse(e.responseText);return console.log(l,"Returning 403 error",t),t?.error}return null})(e,t,o)}}),console.log(l,"check completed. status",n),n},P=()=>(e("body").on("click","#upgrade_button",(()=>{e("#upgrade_button").html('<i class="fa fa-spinner fa-spin" aria-hidden="true"></i>'),he()})),'<button id="upgrade_button" class="mui-btn mui-btn--primary">Upgrade</button>'),E=(e,t,o)=>{console.log(l,"In /checkVersion error callback"),d.version_is_up_to_date=!1;let n=JSON.parse(e.responseText);console.log(l,n);let r=n?.pypi_version;let s=`<div class="mui--text-subhead">A new version of Jupyter Cogram is out  🎈<span class="mui--text-body2"><div style="line-height:120%;"><br></div>Click here to automatically upgrade to version ${r}</span></div>`+P()+'<span class="mui--text-body1"><br>Alternatively, you can upgrade to manually by running<br><span style="font-family:monospace">pip install -U jupyter-cogram</span> <br>in your terminal. Afterwards, please restart your Jupyter Notebook server.</span>';se(s,p.upgrade_message_timeout)},X=t=>{e.ajax({url:"/config",type:"PUT",data:JSON.stringify(t),headers:{"X-XSRFToken":h("_xsrf")},dataType:"json",async:!1,contentType:"application/json",success:function(){},error:function(e,t,o){let n=JSON.parse(e.responseText),r=`Error ${e.status}: ${n.error}`;console.log("Have error msg from `updateConfig()`",r)}})};const I=t=>{t?(console.log(l,"Extension is off. Turning it on."),e("#cogram-status").show(),d.is_open=!0):(console.log(l,"Extension is on. Turning it off."),e("#cogram-status").hide(),d.is_open=!1)},U=t=>{t.attr("id","info-panel-content"),console.log("Showing panel with content",t),e("#info-panel-content").remove(),e("#jupyter-cogram-info-panel").append(t),e("#jupyter-cogram-info-panel").show()},H=(t=!1)=>{if(d.is_open)return void I(!1);const o=D(t);console.log(l,"Valid token exists:",o),"ok"===o?(e("#jupyter-cogram-info-panel").hide(),I(!0)):"unavailable"===o?re(de,1e4):o?U(ie(o)):(U(ie()),I(!1))};function F(e){return e.ctrlKey||e.metaKey}function L(e){const t=e.which;return t===m.left||t===m.right}function M(e){const t=e.which;return t===m.up||t===m.down}const K=e=>e.which===m.tab,V=e=>e.which===m.backspace,W=e=>{const t=d.current_choice_idx,o=d.choices.length;if(1===o)return;let n;n=e?t<=o-2?t+1:0:t>0?t-1:o-1,d.current_choice_idx=n};const B=()=>{const e=f(),t=e.code_mirror.getCursor().line,o=e.code_mirror.getCursor().ch;return e.code_mirror.getLine(t).length===o};function z(t){var o;(o=f()).get_text().split("\n")[o.code_mirror.getCursor().line].trim();const n=B();return d.is_open&&d.considering_choices?(e("#hint-accept-link").click(),t.preventDefault(),!0):!(!d.is_open||!n)&&(G(0),t.preventDefault(),!0)}const Y=()=>{let e=f().get_text().split("\n");if(0===e.length)return!1;let t=e[e.length-1];return!!t.startsWith("#")||(!!(e.length>1&&e[e.length-2].startsWith("#"))||""!==t.trim())},G=(e=p.modify_query_delay)=>{d.queryTimeout=setTimeout(J,e)},Q=()=>{console.log(l,"Patching 'Cell.prototype.handle_codemirror_keyevent'");let t=g.prototype.handle_codemirror_keyevent;g.prototype.handle_codemirror_keyevent=function(o,n){const r=-1!==_.indexOf(n.which),s=F(n),i=B(),c=Y(),a=String.fromCharCode(n.which),u=K(n);let h;if(d.is_open&&console.log(l,"Handling keyevent",n.key,"type",n.type,`character '${a}'`,"is special?",r,"isTab?",u,"command plus event?",s,"isAtEndOfLine?",i,"isNonEmpty?",c),this instanceof g&&d.is_open&&!r&&!s){$(),d.queryTimeout&&clearTimeout(d.queryTimeout),d.current_completion_query&&(d.current_completion_query.abort(),d.current_completion_query=void 0),""===this.get_text().trim()||(u?(h=z(n),console.log(l,"Received CM ignore from Tab key",h)):d.considering_choices&&d.choices.length>1&&L(n)?(n.preventDefault(),W(n.which===m.right),R()):d.considering_choices&&L(n)?(n.preventDefault(),console.log(l,"Recording left/right key")):d.considering_choices&&M(n)?(n.preventDefault(),console.log(l,"Recording up/down key")):d.considering_choices&&V(n)?(console.log(l,"Recording backspace key. Deleting suggestion."),n.preventDefault(),e("#hint-delete-link").click()):d.considering_choices?(console.log(l,"Recording ordinary key. Deleting suggestion."),e("#hint-delete-link").click(),p.auto_submit&&G()):i&&p.auto_submit&&G())}return h??t.apply(this,arguments)}},Z=(e,t,o)=>{if(console.log("jupyter_cogram ajax error:",e,t,o),"abort"===t)return;if(408===e?.status||409===e?.status)return void console.log(l,"Request timed out");let n=JSON.parse(e?.responseText??"");re(`${n?.message}`,1e4)},ee=({id:t,options:o,options_key:n,min:r,max:s,step:i})=>{let c=e('<span style="margin-left:20px">'),a=e(`<input id="${t}" type="number" min="${r}" max="${s}" step="${i}" value="${o[n]}"/>`);return a.addClass("cogram-menu-float-input"),e("body").on("input",`#${t}`,(()=>{let r=parseFloat(e(`#${t}`).val());o[n]=r;let s={};s[n]=r,X(s)})),c.append(a),c.prop("outerHTML")},te=()=>{let t=e('<div id="presets-editor">');t.css("border","1px solid grey").css("border-radius","2px");let o=e("<textarea>");t.append(o);let i=c.fromTextArea(o[0],{lineNumbers:!0,indentUnit:4,autoIndent:!0,mode:"python"});i.setOption("value",p.prompt_presets);let a=r.modal({title:s.msg._("Cogram prompt presets"),body:t,notebook:n.notebook,keyboard_manager:n.notebook.keyboard_manager,default_button:"Save",buttons:{Cancel:{},Save:{class:"btn-primary",click:function(){let e=i.getValue();p.prompt_presets=e,X({prompt_presets:p.prompt_presets})}}}});a.attr("id","presets-modal"),e("body").click((function(t){e(t.target).is("#presets-modal")&&a.modal("hide")})),a.on("shown.bs.modal",(function(){i.refresh()}))},oe=()=>{let t=e(`<span class="dropdown"><a href="#" class="dropdown-toggle" id="cogramlink" data-toggle="dropdown" aria-haspopup="true" aria-controls="cogram_menu">\n    <span class="fa fa-cogs" id="cogram-menu-icon"></span></a>\n    <ul id="cogram_menu" class="dropdown-menu" role="menu" aria-labelledby="cogramlink">\n        <li class="cogram-menu-item" role="none" title="Adjust the temperature">\n            Temperature:\n            ${ee({id:"temp-slider",options:p,options_key:"temperature",min:0,max:1,step:.05})}\n        </li>\n        <li class="cogram-menu-item" role="none" title="Change the number of suggestions">\n            Number of suggestions:\n            ${ee({id:"suggestions-slider",options:p,options_key:"n_suggestions",min:1,max:5,step:1})}\n        </li>\n    </ul>\n</span>`);if(p.demo_mode){let o=e(`<li class="divider" role="none"></li>\n        <li class="cogram-menu-item" role="none" title="Change the prompt presets">\n            ${(()=>{let t=e('<a href="#" id="presets-link" role="menuitem" style="padding-left:0;">Presets</a>');return e("body").on("click","#presets-link",te),t.prop("outerHTML")})()}\n        </li>`);t.find("ul").append(o)}return t},ne=()=>{let t=e("<button/>").attr("id","cogram-status").attr("class","btn btn-default").attr("title","Cogram status").attr("style","display: none;"),o=e("<i/>").attr("id","cogram-spinner").attr("style","color: green;").attr("class","fa fa-circle-o-notch");t.append(o),e("#cogram-button-group").append(t)},re=(t,o=2e3)=>{console.log(l,"Showing alert message");const n=e("#info-panel-content").html();let r=e("<div class='mui--text-body2 alert-message'>"+t+"</div>");U(r),o&&setTimeout((()=>{n&&e("#info-panel-content").html(n),e("#jupyter-cogram-info-panel").hide()}),o)},se=(t,o=5e3)=>{console.log(l,"Showing success message with timeout",o);const n=e("#info-panel-content").html();let r=e("<div class='mui--text-body2 success-message'>"+t+"</div>");U(r),o&&setTimeout((()=>{n&&e("#info-panel-content").html(n),e("#jupyter-cogram-info-panel").hide()}),o)},ie=(t=null)=>{let o=e('<div id="info-panel-content"/>');t?o.html(t):o.text("Please submit your API token");let n=e('<form id="token_submit_form"><div class="mui-textfield"><input type="text"name="api_token" placeholder="Your API token" spellcheck="false"class="mui--is-empty mui--is-pristine mui--is-touched"></div><button id="cogram_token_submit" class="mui-btn mui-btn--primary" type="submit">Submit</button></form>');return o.append(n),e("body").on("submit","#token_submit_form",(t=>{t.preventDefault();const o=t.target,[n,r]=(t=>{console.log(l,"Submitting token",t);let o,n=!1;return e.post({url:"/token",data:JSON.stringify({auth_token:t}),headers:{"X-XSRFToken":h("_xsrf")},dataType:"json",async:!1,contentType:"application/json",success:function(e){d.auth_token=t,I(!0),n=!0},error:function(e,t,n){let r=JSON.parse(e.responseText);o=`Error ${e.status}: ${r.error}`,console.log("Have error msg from `submitToken()`",o)}}),console.log(l,"Token submission completed. Success?",n),[n,o]})(o?.api_token?.value);n?se("Thanks, your token looks good 🎉",2e3):re(r,5e3)})),o},ce=()=>{e("#hint-accept-link").click((e=>{e.preventDefault(),O()})),e("#hint-delete-link").click((e=>{e.preventDefault(),(()=>{const e=d.pre_cursor+d.post_cursor,t=f();t.set_text(e),b({text:d.pre_cursor,_cell:t}),S(),le(),C()})()})),e("#hint-left-link").click((e=>{e.preventDefault(),W(!1),R()})),e("#hint-right-link").click((e=>{e.preventDefault(),W(!0),R()}))},ae=(t,o=null,n="-=14")=>{let r=e('<div class="mui-panel" id="cogram-hint"/>');o&&r.addClass(o);let s=e(`<div class="mui--text-body2" id="cogram-hint-text">${t}</div>`);r.append(s);const i=(()=>{const t=e(".cell.code_cell.selected .CodeMirror-cursors").children().last();return t.length?[t.css("left"),t.css("top")]:(console.log(l,"Could not find cursors in cell, returning [0, 0]"),[0,0])})();r.css("left",i[0]).css("top",i[1]),r.css("left","+=102").css("top",n),e(".cell.code_cell.selected .inner_cell").append(r),ce()},le=()=>e("#cogram-hint").remove(),ue=()=>{var e,t;le(),ae((e="&nbsp &nbsp",t="",d.choices.length>1&&(t+=`<a href="#" class="hint-accept" id="hint-right-link">Next (→)</a> ${e} <a href="#" class="hint-accept" id="hint-left-link">Previous (←)</a> ${e}`),t+`<a href="#" class="hint-accept" id="hint-accept-link">Accept (Tab)</a> ${e} <a href="#" class="hint-accept" id="hint-delete-link">Delete (⌫)</a>`))},pe=e=>{let t=document.createElement("link");t.type="text/css",t.rel="stylesheet",t.href=o.toUrl(e),document.getElementsByTagName("head")[0].appendChild(t)},de="The Cogram API server is unavailable. Please refresh and try again. If this keeps happening, please contact support@cogram.ai",ge=()=>{const t=D();"ok"===t?(console.log(l,"Checking if version is up to date..."),e.get({url:"/checkVersion",dataType:"JSON",async:!1,success:function(e){d.version_is_up_to_date=!0},error:E})):"unavailable"===t?re(de,1e4):U(t?ie(t):ie())},me=t=>{d.version_is_up_to_date=!0;let o=`<div class="mui--text-subhead">Successfully upgraded to version ${t?.new_version} 🎉<span class="mui--text-body2"><br>Please refresh your notebook:</span></div>`+(e("body").on("click","#refresh_button",(()=>{window.location.reload()})),'<button id="refresh_button" class="mui-btn mui-btn--primary">Refresh</button>');se(o,p.upgrade_message_timeout)},_e=(e,t,o)=>{d.version_is_up_to_date=!1;let n=JSON.parse(e.responseText);d.version_is_up_to_date=!1,console.log(l,"Auto upgrade error:",n),re(`<span class="mui--text-body2">${n?.message}</span>`,1e4)},he=()=>{(console.log(l,"Upgrading package"),e.post({url:"/upgrade",headers:{"X-XSRFToken":h("_xsrf")},dataType:"json",contentType:"application/json",success:me,error:_e})).then((e=>console.log(l,"`autoUpgrade()` result:",e))).catch((e=>console.log(l,"Error in `autoUpgrade()`:",e)))},fe=()=>{(()=>{let t=e("<button/>").attr("id","cogram-config").attr("class","btn btn-default").attr("title","Cogram config");return t.append(oe()),t})().insertBefore(e("#cogram-status"))},ye=()=>{console.log(l,"Initializing extension..."),n.toolbar.add_buttons_group([n.keyboard_manager.actions.register({help:"Launch jupyter-cogram",icon:"fas fa-link",handler:H},"create-jupyter-cogram-from-notebook","Cogram")],"cogram-button-group"),e(".fas.fa-link.fa").replaceWith(`<img id="cogram-button-logo" src="${u}" style="max-height:16px;"alt="Cogram">`),ne(),H(!0),ge(),be(),(()=>{let t,o;d.auth_token||console.log(l,"No valid token. Skipping launch message."),e.get({url:"/launch",headers:{"X-XSRFToken":h("_xsrf")},async:!1,dataType:"JSON",success:e=>{console.log(l,"Have launch result",e),t=e?.status,o=e?.msg},error:(e,t,o)=>{console.log(l,"Have launch result error",e)}}),o&&["first_launch","new_version"].includes(t)&&(console.log(l,"Will show success message.",o),se(o,6e4))})(),fe()},be=()=>{e.get({url:"/config",async:!1,dataType:"JSON",success:function(e){e&&(console.log(l,"Received config data from server",e),p={...p,...e})}})};function ke(){pe("//cdn.muicss.com/mui-0.10.3/css/mui.min.css"),pe("./jupyter_cogram.css"),Q(),function(){console.log(l,"Patching 'CodeCell.prototype.execute'");let e=g.prototype.execute;g.prototype.execute=function(t){return j(),e.apply(this,arguments)}}(),(()=>{let t=e("<div/>").attr("id","jupyter-cogram-info-panel").attr("class","cogram_info_panel_display mui-panel mui--text-subhead mui--z2").attr("style","display: none;"),o=e("<div id='cogram_token_close'>x</div>");t.append(o).append(e('<div id="info-panel-content"/>')),e("body").on("click","#cogram_token_close",(()=>e("#jupyter-cogram-info-panel").hide())),e("body").on("focus","#jupyter-cogram-info-panel",(()=>n.keyboard_manager.disable())),e("body").on("blur","#jupyter-cogram-info-panel",(()=>n.keyboard_manager.enable())),e("#site").prepend(t)})(),n.notebook.kernel?(console.log(l,"Initialising with Kernel ready!"),ye()):(console.log(l,"Kernel not ready. Initialising later"),n.notebook.events.one("kernel_ready.Kernel",(()=>ye())))}return{load_jupyter_extension:ke,load_ipython_extension:ke}}));